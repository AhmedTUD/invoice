# 📊 دليل بنية Excel الجديدة - شيتات الفروع

## 🎯 البنية الجديدة المحسنة

تم إعادة تصميم Excel ليكون **منظماً حسب الفروع** مع بيانات كاملة وصور عالية الجودة.

---

## 📋 بنية الملف الجديدة

### الشيت الرئيسي: "الملخص العام"
```
📊 الملخص العام
┌─────────────────────────────────────────────────────────┐
│ اسم الفرع    │ كود الفرع │ عدد الموظفين │ عدد الفواتير │
├─────────────────────────────────────────────────────────┤
│ فرع القاهرة   │ CAI-01    │ 3          │ 12        │
│ فرع الجيزة    │ GIZ-01    │ 2          │ 8         │
│ فرع الإسكندرية │ ALX-01    │ 4          │ 15        │
└─────────────────────────────────────────────────────────┘
```

### شيتات الفروع: "اسم_الفرع"
```
📋 فرع_القاهرة
┌─────────────────────────────────────────────────────────┐
│ الفرع: فرع القاهرة        │ كود الفرع: CAI-01           │
│ عدد الموظفين: 3          │ عدد الفواتير: 12            │
│ تاريخ التقرير: 19/01/2026 │                            │
├─────────────────────────────────────────────────────────┤
│ اسم الموظف │ كود الموظف │ الموبايل │ الموديل │ التاريخ │ الصورة │
├─────────────────────────────────────────────────────────┤
│ أحمد محمد   │ EMP-001    │ 0123...  │ RS68... │ 19/01  │ [🖼️]   │
│ أحمد محمد   │ EMP-001    │ 0123...  │ WW11... │ 18/01  │ [🖼️]   │
│ سارة أحمد   │ EMP-002    │ 0124...  │ RB34... │ 17/01  │ [🖼️]   │
│ محمد علي    │ EMP-003    │ 0125...  │ RT40... │ 16/01  │ [🖼️]   │
└─────────────────────────────────────────────────────────┘
```

---

## 🎨 التنسيق والألوان

### شيت الملخص العام:
- **لون الهيدر**: أخضر داكن (#2E7D32)
- **خط الهيدر**: أبيض، عريض، 14pt
- **ارتفاع الهيدر**: 35 بكسل
- **محاذاة**: وسط للجميع

### شيتات الفروع:
- **معلومات الفرع**: خلفية بنفسجية فاتحة (#F3E5F5)
- **لون الهيدر**: أزرق داكن (#1565C0)
- **خط الهيدر**: أبيض، عريض، 12pt
- **ارتفاع الصفوف**: 120 بكسل للصور

### الصور:
- **الحجم**: 180x100 بكسل (جودة عالية)
- **الموضع**: عمود "صورة الفاتورة"
- **الجودة**: أصلية بدون ضغط
- **التنسيق**: مدمجة في الخلايا

---

## 🔧 التحسينات التقنية

### معالجة الصور:
```typescript
// تحديد نوع الصورة تلقائياً
let extension = 'jpeg';
if (record.fileDataUrl.includes('data:image/png')) {
    extension = 'png';
}

// إدراج بحجم أكبر وجودة أعلى
storeSheet.addImage(imageId, {
    tl: { col: 6, row: row.number - 1 },
    ext: { width: 180, height: 100 }, // حجم محسن
    editAs: 'oneCell'
});
```

### تجميع البيانات:
```typescript
// تجميع بسيط حسب الفرع فقط
const groupedByStore: Record<string, JoinedRecord[]> = {};
filteredRecords.forEach(record => {
    const storeKey = record.storeName || 'فرع غير محدد';
    if (!groupedByStore[storeKey]) {
        groupedByStore[storeKey] = [];
    }
    groupedByStore[storeKey].push(record);
});
```

### أسماء الشيتات:
```typescript
// أسماء آمنة للشيتات (حد أقصى 31 حرف)
const safeStoreName = storeName
    .replace(/[^a-zA-Z0-9\u0600-\u06FF_]/g, '_')
    .substring(0, 31);
```

---

## 📊 مثال على الاستخدام

### السيناريو: شركة بها 3 فروع
```
🏢 الشركة لديها:
├── 📍 فرع القاهرة (3 موظفين، 12 فاتورة)
├── 📍 فرع الجيزة (2 موظف، 8 فواتير)  
└── 📍 فرع الإسكندرية (4 موظفين، 15 فاتورة)
```

### النتيجة في Excel:
```
📊 FSMI_تقرير_الفروع_2026-01-19.xlsx
├── 📋 الملخص العام (إحصائيات الفروع)
├── 📋 فرع_القاهرة (12 فاتورة مع صور)
├── 📋 فرع_الجيزة (8 فواتير مع صور)
└── 📋 فرع_الإسكندرية (15 فاتورة مع صور)
```

### محتوى شيت "فرع_القاهرة":
```
┌─────────────────────────────────────────────────────────┐
│ الفرع: فرع القاهرة        │ كود الفرع: CAI-01           │
│ عدد الموظفين: 3          │ عدد الفواتير: 12            │
├─────────────────────────────────────────────────────────┤
│ أحمد محمد │ EMP-001 │ 0123... │ RS68AB820B1/MR │ [🖼️ صورة] │
│ أحمد محمد │ EMP-001 │ 0123... │ WW11B944DGB/AS │ [🖼️ صورة] │
│ سارة أحمد │ EMP-002 │ 0124... │ RB34C671E59/MR │ [🖼️ صورة] │
│ ...      │ ...     │ ...     │ ...            │ [🖼️ صورة] │
└─────────────────────────────────────────────────────────┘
```

---

## 💡 الفوائد العملية

### للمديرين:
- 📈 **نظرة شاملة**: الملخص العام يعطي صورة كاملة
- 🔍 **تفاصيل دقيقة**: كل فرع في شيت منفصل
- 📊 **إحصائيات واضحة**: عدد الموظفين والفواتير
- 🖼️ **صور عالية الجودة**: للمراجعة والتدقيق

### لمديري الفروع:
- 🎯 **بيانات فرعهم فقط**: في شيت منفصل
- 👥 **جميع موظفي الفرع**: في مكان واحد
- 📋 **تفاصيل كاملة**: اسم، كود، موبايل، موديل
- 🖼️ **صور الفواتير**: للتحقق والمراجعة

### للمحاسبين:
- 📊 **بيانات منظمة**: سهلة المراجعة والتدقيق
- 🔢 **أرقام واضحة**: كودات الموظفين والفروع
- 📅 **تواريخ دقيقة**: لكل فاتورة
- 💰 **سهولة الحساب**: للحوافز والمكافآت

---

## 🧪 خطوات الاختبار

### 1. تحضير البيانات:
- تأكد من وجود فواتير من فروع مختلفة
- تأكد من وجود صور مرفوعة مع الفواتير

### 2. تصدير Excel:
1. اذهب للوحة الإدارة
2. اضغط "Excel متقدم (شيتات منفصلة)"
3. انتظر التحميل (قد يستغرق دقيقة)
4. افتح الملف المحمل

### 3. التحقق من النتائج:
- ✅ **شيت الملخص**: يحتوي على إحصائيات الفروع
- ✅ **شيتات الفروع**: كل فرع في شيت منفصل
- ✅ **الصور**: تظهر بوضوح في عمود "صورة الفاتورة"
- ✅ **التنسيق**: ألوان وحدود احترافية

---

## 🔧 استكشاف الأخطاء

### إذا لم تظهر الصور:
1. **تحقق من Console**: ابحث عن أخطاء JavaScript
2. **تحقق من البيانات**: تأكد من أن `fileDataUrl` يبدأ بـ `data:image`
3. **جرب صور أصغر**: قد تكون الصور كبيرة جداً
4. **استخدم Chrome**: أفضل دعم لـ ExcelJS

### إذا كانت الشيتات فارغة:
1. **تحقق من البيانات**: تأكد من وجود فواتير
2. **تحقق من أسماء الفروع**: يجب أن تكون واضحة
3. **راجع Console**: للأخطاء في التجميع

### إذا فشل التحميل:
1. **أغلق النوافذ الأخرى**: لتوفير الذاكرة
2. **جرب بيانات أقل**: فلتر البيانات أولاً
3. **أعد تشغيل المتصفح**: لتنظيف الذاكرة

---

## 🎉 النتيجة النهائية

Excel الجديد يوفر:
- 📊 **تنظيم مثالي**: شيت لكل فرع
- 🖼️ **صور عالية الجودة**: 180x100 بكسل
- 📋 **بيانات كاملة**: جميع المعلومات المطلوبة
- 🎨 **مظهر احترافي**: مناسب للعروض الرسمية
- 📈 **إحصائيات شاملة**: في شيت الملخص

**جرب التصدير الآن وستحصل على تقرير احترافي متكامل! 🚀✨**